<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kerry Qian- BIM Interface</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1223.0.js"></script>
<script src="/loadS3.js"></script>
<script>listFiles();</script>
<script src="/js/three.js"></script>
<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.138.3/build/three.module.js"
        }
    }
</script>
<html lang="en">

<body>

  <nav class="main-nav" id="main-nav">
    <div style="height:80px;background: rgb(51,74,92);padding-top: 1px;">
      <h2 class="text-center" style="color:#fff; letter-spacing:2px;">MENU</h2>
    </div>
    <ul class="nav nav-pills nav-stacked">
      <li class="active"><a href="#"><i class="fa fa-home fa-fw"></i>&nbsp; Home</a></li>
      <li><a href="#about"><i class="fa fa-user fa-fw"></i>&nbsp; About</a></li>
      <li><a href="#what-i-do"><i class="fa fa-signal fa-fw"></i>&nbsp; What I do</a></li>
      <li><a href="#work"><i class="fa fa-briefcase fa-fw"></i>&nbsp; Recent Work</a></li>
      <li><a href="#contact"><i class="fa fa-envelope-o fa-fw"></i>&nbsp; Contact</a></li>
    </ul>
  </nav>

  <div class="page-wrap">

    <div class="jumbotron">
      <div style="margin-top:130px" class="container">
        <a href="#main-nav" class="h5 open-menu"><i style="color:#fff; position: relative; bottom:120px; cursor:pointer;" class="fa fa-bars fa-2x fa-fw"></i></a>
        <a href="#" class="h5 close-menu"><i style="color:#fff; position: relative; bottom:120px; cursor:pointer;" class="fa fa-times fa-2x fa-fw"></i></a>
        <h1>BIM:</h1>
        <div class="spacer"></div>
        <h1>Visualisation Interface </h1>
        <div class="spacer"></div>
        <hr>
        <hr>
        <h2 class="text-center">Kerry Qian | UNSW CoDe2270 | T3 2022</h2>
      </div>
    </div>

    <div class="section" id="about">
      <h1>About</h1>
      <hr>
    </div>

    <div class="container">
      <div class="text-center">
        <p>An interactive webpage for a residential building.</p>
      </div>
      <!--/.row-->
    </div>
    <!--/.container-->

    <div class="section" id="what-i-do">
      <hr>
    </div>

        </div>
        <!--/.row-->
      </div>
      <!--/.container-->
      <div class="container hidden-sm hidden-xs">
        <div class="spacer"></div>
        <div class="spacer"></div>
      </div>
    </div>
    <!--/.work-together-->

  </div>
  <!--/.page-wrap-->
</body>

</html>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<div class="canvas">
<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three@0.138.3/build/three.module.js"
				}
			}
		</script>
<script type="module">


  import * as THREE from 'three';
  import { OrbitControls } from 'https://unpkg.com/three@0.138.3/examples/jsm/controls/OrbitControls.js';
  import { IFCLoader } from 'https://unpkg.com/three@0.138.3/examples/jsm/loaders/IFCLoader.js';

  let scene, camera, renderer;

  init();

  function init() {

    //Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0xffffff );

    //Camera
    camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
    camera.position.z = -20;
    camera.position.y = 20;
    camera.position.x = 20;

    //Lights
    const directionalLight1 = new THREE.DirectionalLight( 0xff0000, 0.8 );
    directionalLight1.position.set( 1, 1, 1 );
    scene.add( directionalLight1 );

    const directionalLight2 = new THREE.DirectionalLight( 0xffffff, 0.8 );
    directionalLight2.position.set( - 1, 0.5, - 1 );
    scene.add( directionalLight2 );

    const ambientLight = new THREE.AmbientLight( 0xffffee, 0.25 );
    scene.add( ambientLight );

    //Setup IFC Loader
    const ifcLoader = new IFCLoader();
    ifcLoader.ifcManager.setWasmPath( './model/' );
    ifcLoader.load( 'model/Residential building.ifc', function ( model ) {

    scene.add( model.mesh );
    render();

    } );

    const highlightMaterial = new THREE.MeshPhongMaterial( { color: 0x0000ff, depthTest: false, transparent: true, opacity: 0.1 } );

    function selectObject( event ) {

    if ( event.button != 0 ) return;

    const mouse = new THREE.Vector2();
    mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
    mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera( mouse, camera );

    const intersected = raycaster.intersectObjects( scene.children, false );
    if ( intersected.length ) {

        const found = intersected[ 0 ];
        const faceIndex = found.faceIndex;
        const geometry = found.object.geometry;
        const id = ifcLoader.ifcManager.getExpressId( geometry, faceIndex );

        const modelID = found.object.modelID;
        ifcLoader.ifcManager.createSubset( { modelID, ids: [ id ], scene, removePrevious: true, material: highlightMaterial } );
        const props = ifcLoader.ifcManager.getItemProperties( modelID, id, true );
        console.log( props );
        renderer.render( scene, camera );

    }

    }

    window.onpointerdown = selectObject;

    //Renderer
    renderer = new THREE.WebGLRenderer( { antialias: true	} );
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.setPixelRatio( window.devicePixelRatio );
    document.body.appendChild( renderer.domElement );

    //Controls
    const controls = new OrbitControls( camera, renderer.domElement );
    controls.addEventListener( 'change', render );

    window.addEventListener( 'resize', onWindowResize );

    render();

    }

    function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );

    render();

    }

    function render() {

    renderer.render( scene, camera );

    }

</script>
</body>
</html>
